<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multiplayer Number Guessing Game</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #gameContainer { max-width: 600px; margin: auto; }
    #guessHistory { margin-top: 20px; }
  </style>
</head>
<body>
  <div id="gameContainer">
    <h1>Number Guessing Game</h1>
    <p id="welcome"></p>
    <input type="number" id="guessInput" placeholder="Enter your guess" />
    <button id="submitGuess">Guess</button>
    <div id="feedback"></div>
    <div id="timerDisplay" style="font-size: 1.5em; font-weight: bold; margin-top: 10px;">3:00</div>
    <div id="guessHistory"></div>
  </div>

  <script>
    const firebaseConfig = {
      // your firebase config here
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    let playerId = localStorage.getItem("playerId");
    let playerName = "";

    if (!playerId) {
      playerId = Math.random().toString(36).substring(2, 15);
      localStorage.setItem("playerId", playerId);
    }

    const gameRef = database.ref("game");

    // Fetch username from users/<playerId>/username
    const fetchUsername = async () => {
      const snapshot = await database.ref(`users/${playerId}/username`).once("value");
      playerName = snapshot.val() || "Unknown Player";
      document.getElementById("welcome").innerText = `Welcome, ${playerName}`;
    };

    fetchUsername();

    const guessInput = document.getElementById("guessInput");
    const submitGuess = document.getElementById("submitGuess");
    const feedback = document.getElementById("feedback");
    const guessHistory = document.getElementById("guessHistory");

    submitGuess.addEventListener("click", () => {
      const guess = guessInput.value;
      if (guess === "") return;

      const newGuessRef = gameRef.child("guesses").push();
      newGuessRef.set({
        playerId,
        playerName,
        guess: Number(guess),
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });

      guessInput.value = ""; // Clear after every guess
    });

    gameRef.child("guesses").on("value", (snapshot) => {
      const guesses = snapshot.val();
      guessHistory.innerHTML = "<h3>Guess History:</h3>";
      if (guesses) {
        const sorted = Object.values(guesses).sort((a, b) => a.timestamp - b.timestamp);
        sorted.forEach((g) => {
          const item = document.createElement("p");
          item.textContent = `${g.playerName} guessed ${g.guess}`;
          guessHistory.appendChild(item);
        });
      }
    });

    // Timer Logic
    gameRef.child("timer").on("value", (snapshot) => {
      const data = snapshot.val();
      if (!data || !data.endTime) return;

      const updateTimer = () => {
        const now = Date.now();
        const timeLeft = Math.max(0, Math.floor((data.endTime - now) / 1000));
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById("timerDisplay").textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;

        if (timeLeft <= 0) {
          clearInterval(intervalId);
          alert("Time's up! Game Over.");
        }
      };

      updateTimer();
      const intervalId = setInterval(updateTimer, 1000);
    });
  </script>
</body>
</html>
