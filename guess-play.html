<!DOCTYPE html>
<html>
<head>
    <title>Guess Number Play - HABESHA GAMES</title>
    <style>
        body { /* ... (Your existing styles) ... */ }
        .correct-position { color: green; }
        .correct-number { color: orange; }
    </style>
</head>
<body>
    <h1>Guess Number Game</h1>

    <div class="game-box">
        <div id="timer">Time left: 60s</div>
        <p>Enter your 4-digit guess (no 0s, no repeats):</p>
        <div class="input-group">
            <input id="g1" maxlength="1" type="number" min="1" max="9">
            <input id="g2" maxlength="1" type="number" min="1" max="9">
            <input id="g3" maxlength="1" type="number" min="1" max="9">
            <input id="g4" maxlength="1" type="number" min="1" max="9">
        </div>
        <button onclick="submitGuess()" id="submit-btn">Submit Guess</button>
        <div id="result"></div>
        <div id="history"></div>
        <button onclick="restartGame()">Restart</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = { /* ... (Your Firebase config) ... */ };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get("room");
        const playerId = "player1"; // Replace with your player ID logic

        let secret = [];
        let history = [];
        let timeLeft = 60;
        let gameOver = false;
        let turn; // turn is declared without initialization

        const inputs = ["g1", "g2", "g3", "g4"].map(id => document.getElementById(id));
        const submitBtn = document.getElementById("submit-btn");
        const resultEl = document.getElementById("result");

        inputs.forEach((input, idx) => {
            input.addEventListener("input", () => {
                if (input.value.length === 1 && idx < 3) {
                    inputs[idx + 1].focus();
                }
            });
        });

        const gameRef = doc(db, "games", roomId);

        onSnapshot(gameRef, (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                if (!data.joined) {
                    resultEl.innerText = "Waiting for another player to join...";
                    submitBtn.disabled = true;
                } else {
                    secret = data.secret;
                    resultEl.innerText = "Player joined! Start guessing!";
                    turn = data.turn; // turn is set from firebase data
                    submitBtn.disabled = (turn !== playerId);
                    inputs.forEach(input => input.disabled = (turn !== playerId));
                    startTimer();
                }

                if (data.winner && !gameOver) {
                    gameOver = true;
                    resultEl.innerText = `ðŸŽ‰ Game over! Player ${data.winner} won.`;
                    disableInputs();
                }
                turn = data.turn; // turn is updated from firebase data
                submitBtn.disabled = (turn !== playerId);
                inputs.forEach(input => input.disabled = (turn !== playerId));
            } else {
                resultEl.innerText = "Game not found.";
                submitBtn.disabled = true;
            }
        });

        function startTimer() { /* ... (Your timer logic) ... */ }

        function disableInputs() { /* ... (Your disableInputs logic) ... */ }

        window.submitGuess = async function () {
            if (gameOver || turn !== playerId) return;

            const guess = inputs.map(input => parseInt(input.value));
            if (guess.includes(0) || new Set(guess).size !== 4 || guess.some(n => n < 1 || n > 9 || isNaN(n))) {
                resultEl.innerText = "Invalid guess. Use 1-9 without repeats.";
                return;
            }

            let correctPosition = 0;
            let correctNumber = 0;
            let feedback = "";
            for (let i = 0; i < 4; i++) {
                if (guess[i] === secret[i]) {
                    correctPosition++;
                    feedback += `<span class="correct-position">${guess[i]}</span>`;
                } else if (secret.includes(guess[i])) {
                    correctNumber++;
                    feedback += `<span class="correct-number">${guess[i]}</span>`;
                } else {
                    feedback += guess[i];
                }
            }

            history.unshift(`Guess: ${feedback}`);
            document.getElementById("history").innerText = history.join("\n");

            if (correctPosition === 4) {
                resultEl.innerText = "ðŸŽ‰ You guessed it! Game over.";
                disableInputs();
                gameOver = true;
                await updateDoc(gameRef, { winner: playerId });
            } else {
                resultEl.innerText = `Correct numbers in correct place: ${correctPosition}\nCorrect numbers in wrong place: ${correctNumber}`;
                await updateDoc(gameRef, { turn: (playerId === "player1")? "player2" : "player1"});
            }

            inputs.forEach(input => input.value = "");
        }

        window.restartGame = function () { /* ... (Your restartGame logic) ... */ }
    </script>
</body>
</html>
