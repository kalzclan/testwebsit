<!DOCTYPE html>
<html>
<head>
  <title>Telegram Auto Register</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding-top: 50px;
    }
  </style>
</head>
<body>
  <h2 id="heading">Login with Telegram</h2>

  <!-- Telegram Login Button -->
  <div id="telegram-login-btn">
    <script async src="https://telegram.org/js/telegram-widget.js?7"
            data-telegram-login="kbabenibot"
            data-size="large"
            data-userpic="false"
            data-request-access="write">
    </script>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK1cWayLcccmgOmygFmW1otwlAPcrUSNw",
      authDomain: "habeshagames-1f999.firebaseapp.com",
      projectId: "habeshagames-1f999",
      storageBucket: "habeshagames-1f999.firebasestorage.app",
      messagingSenderId: "919693990773",
      appId: "1:919693990773:web:f32664a1b944b38101113c",
      measurementId: "G-G5C67RMJDY"
    };

    const app = initializeApp(firebaseConfig);
    const firestore = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const telegramId = urlParams.get("id");
    const username = urlParams.get("username");
    const firstName = urlParams.get("first_name");
    const lastName = urlParams.get("last_name");

    if (telegramId && username) {
      // Hide login button and heading
      document.getElementById("telegram-login-btn").style.display = "none";
      document.getElementById("heading").textContent = "Logging you in...";

      const userRef = doc(firestore, "users", telegramId);

      getDoc(userRef).then(async (docSnap) => {
        if (!docSnap.exists()) {
          // New user: save to Firestore
          await setDoc(userRef, {
            telegramId,
            username,
            firstName,
            lastName,
            createdAt: new Date().toISOString()
          });
        }

        // Save ID in session and redirect
        sessionStorage.setItem("telegramId", telegramId);
        window.location.href = "/home.html?id=" + telegramId;
      }).catch((err) => {
        console.error("Login error:", err);
        document.getElementById("heading").textContent = "Something went wrong!";
      });
    }
  </script>
</body>
</html>
