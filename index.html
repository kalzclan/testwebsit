<!DOCTYPE html>
<html>
<head>
  <title>Login/Register</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding-top: 50px;
    }
    #register-form {
      display: none;
      margin-top: 20px;
    }
    input {
      margin: 5px;
      padding: 8px;
      width: 200px;
    }
  </style>
</head>
<body>
  <h2 id="heading">Login with Telegram</h2>

  <!-- Telegram Login Button -->
  <div id="telegram-login-btn">
    <script async src="https://telegram.org/js/telegram-widget.js?7"
            data-telegram-login="kbabenibot"
            data-size="large"
            data-userpic="false"
            data-request-access="write">
    </script>
  </div>

  <!-- Register Form for new users -->
  <div id="register-form">
    <h3>Complete Registration</h3>
    <input type="text" id="name" placeholder="Your Name"><br>
    <input type="text" id="phone" placeholder="Phone Number"><br>
    <button onclick="submitRegistration()">Submit</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK1cWayLcccmgOmygFmW1otwlAPcrUSNw",
      authDomain: "habeshagames-1f999.firebaseapp.com",
      projectId: "habeshagames-1f999",
      storageBucket: "habeshagames-1f999.firebasestorage.app",
      messagingSenderId: "919693990773",
      appId: "1:919693990773:web:f32664a1b944b38101113c",
      measurementId: "G-G5C67RMJDY"
    };

    const app = initializeApp(firebaseConfig);
    const firestore = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const telegramId = urlParams.get("id");
    const username = urlParams.get("username");
    const firstName = urlParams.get("first_name");
    const lastName = urlParams.get("last_name");

    if (telegramId && username) {
      document.getElementById("telegram-login-btn").style.display = "none";
      document.getElementById("heading").textContent = "Checking your account...";

      const userRef = doc(firestore, "users", telegramId);

      getDoc(userRef).then(async (docSnap) => {
        if (docSnap.exists()) {
          // Existing user
          sessionStorage.setItem("telegramId", telegramId);
          window.location.href = "/home.html?id=" + telegramId;
        } else {
          // New user, show registration form
          document.getElementById("register-form").style.display = "block";
          window.userInfo = {
            telegramId,
            username,
            firstName,
            lastName
          };
        }
      }).catch((err) => {
        console.error("Login error:", err);
        document.getElementById("heading").textContent = "Something went wrong!";
      });
    }

    window.submitRegistration = async function () {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();

      if (!name || !phone) {
        alert("Please fill in all fields");
        return;
      }

      const userRef = doc(firestore, "users", window.userInfo.telegramId);

      await setDoc(userRef, {
        ...window.userInfo,
        fullName: name,
        phone: phone,
        createdAt: new Date().toISOString()
      });

      sessionStorage.setItem("telegramId", window.userInfo.telegramId);
      window.location.href = "/home.html?id=" + window.userInfo.telegramId;
    };
  </script>
</body>
</html>
