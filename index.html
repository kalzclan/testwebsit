<!DOCTYPE html>
<html>
<head>
  <title>Firebase Telegram Auth</title>
</head>
<body>
  <h2>Telegram Login with Firebase Check</h2>

  <!-- Telegram Login Button -->
  <script async src="https://telegram.org/js/telegram-widget.js?7"
          data-telegram-login="kbabenibot"  <!-- Replace with your Bot's username -->
          data-size="large"
          data-userpic="false"
          data-request-access="write"
          data-onauth="onTelegramAuth(user)"></script>

  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK1cWayLcccmgOmygFmW1otwlAPcrUSNw",
      authDomain: "habeshagames-1f999.firebaseapp.com",
      projectId: "habeshagames-1f999",
      storageBucket: "habeshagames-1f999.firebasestorage.app",
      messagingSenderId: "919693990773",
      appId: "1:919693990773:web:f32664a1b944b38101113c",
      measurementId: "G-G5C67RMJDY"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const firestore = getFirestore(app);

    // Telegram login callback
    window.onTelegramAuth = async function(user) {
      const telegramId = user.id.toString();
      const username = user.username;

      try {
        const userRef = doc(firestore, "users", telegramId);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          // ✅ User found → redirect to home
          window.location.href = "/home.html";
        } else {
          // ❌ User not found → redirect to register with query params
          const params = new URLSearchParams({
            username: username || "",
            id: telegramId
          }).toString();
          window.location.href = "/register.html?" + params;
        }
      } catch (err) {
        console.error("Error checking user:", err);
      }
    };
  </script>
</body>
</html>
