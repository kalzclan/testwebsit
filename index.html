<!DOCTYPE html>
<html>
<head>
  <title>Firebase Connection</title>
</head>
<body>
  <h2 id="heading">Welcome</h2>

  <!-- Registration form (hidden by default) -->
  <div id="register-form" style="display: none;">
    <input type="text" id="username" placeholder="Enter your name" /><br />
    <input type="text" id="phone" placeholder="Enter your phone number" /><br />
    <button onclick="saveData()">Register</button>
  </div>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCK1cWayLcccmgOmygFmW1otwlAPcrUSNw",
      authDomain: "habeshagames-1f999.firebaseapp.com",
      projectId: "habeshagames-1f999",
      storageBucket: "habeshagames-1f999.appspot.com",
      messagingSenderId: "919693990773",
      appId: "1:919693990773:web:f32664a1b944b38101113c",
      measurementId: "G-G5C67RMJDY"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const firestore = getFirestore(app);

    // Check if user is already registered
    window.addEventListener("DOMContentLoaded", async () => {
      const userId = localStorage.getItem("userId");
      if (userId) {
        const userRef = doc(firestore, "users", userId);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          window.location.href = "/home.html?id=" + userId;
          return;
        } else {
          localStorage.removeItem("userId");
        }
      }
      // Show form if not registered
      document.getElementById("register-form").style.display = "block";
    });

    // Save new user data
    window.saveData = async function () {
      const username = document.getElementById("username").value.trim();
      const phone = document.getElementById("phone").value.trim();

      if (!username || !phone) {
        alert("Please fill in both name and phone.");
        return;
      }

      const userId = Date.now().toString(); // use timestamp as unique ID

      try {
        await setDoc(doc(firestore, "users", userId), {
          username: username,
          phone: phone,
          createdAt: new Date().toISOString()
        });
        localStorage.setItem("userId", userId);
        window.location.href = "/home.html?id=" + userId;
      } catch (err) {
        console.error("Error saving user:", err);
        alert("Failed to save user.");
      }
    }
  </script>
</body>
</html>
