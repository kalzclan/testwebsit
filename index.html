<!DOCTYPE html>
<html>
<head>
  <title>Telegram Auto Register</title>
</head>
<body>
  <h2>Login with Telegram</h2>

  <!-- Telegram Login Button -->
  <script async src="https://telegram.org/js/telegram-widget.js?7"
          data-telegram-login="kbabenibot"
          data-size="large"
          data-userpic="false"
          data-request-access="write">
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK1cWayLcccmgOmygFmW1otwlAPcrUSNw",
      authDomain: "habeshagames-1f999.firebaseapp.com",
      projectId: "habeshagames-1f999",
      storageBucket: "habeshagames-1f999.firebasestorage.app",
      messagingSenderId: "919693990773",
      appId: "1:919693990773:web:f32664a1b944b38101113c",
      measurementId: "G-G5C67RMJDY"
    };

    const app = initializeApp(firebaseConfig);
    const firestore = getFirestore(app);

    // Read Telegram query params
    const urlParams = new URLSearchParams(window.location.search);
    const telegramId = urlParams.get("id");
    const username = urlParams.get("username");
    const firstName = urlParams.get("first_name");
    const lastName = urlParams.get("last_name");

    if (telegramId && username) {
      const userRef = doc(firestore, "users", telegramId);

      getDoc(userRef).then(async (docSnap) => {
        if (docSnap.exists()) {
          // âœ… Already registered â†’ go to home
          window.location.href = "/home.html";
        } else {
          // ðŸ†• New user â†’ save to Firestore then redirect
          await setDoc(userRef, {
            telegramId,
            username,
            firstName,
            lastName,
            createdAt: new Date().toISOString()
          });
          window.location.href = "/home.html";
        }
      }).catch(err => {
        console.error("Error checking/saving user:", err);
      });
    }
  </script>
</body>
</html>
